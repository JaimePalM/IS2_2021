package practica3;

import java.util.Timer;
import java.util.TimerTask;

/**
 * Clase del estado Programado, en el que al menos hay una alarma activada.
 * @author Jesus y Jaime
 *
 */
public class Programado extends ControladorAlarmaState {

	protected Timer timer = new Timer();
	protected SuenaAlarmaTask suenaAlarmaTask;

	public void entryAction(ControladorAlarma context) {
		System.out.println("MODIFICACION EN ALARMAS");
		if (context.alarmasActivadas().isEmpty()) {
			ControladorAlarmaState estadoDesprogramado = getEstadoDesprogramado();
			context.setState(estadoDesprogramado);
		} else {
			// Configura el temporizador para hacer sonar la alarma
			suenaAlarmaTask = new SuenaAlarmaTask(context);
			timer.schedule(suenaAlarmaTask, context.alarmaMasProxima().getHora());
		}
	}

	// Cada vez que se modifique una alarma se vuelve a hacer el entry de programado
	// por si esa alarma resulta ser ahora o deja de ser la mas proxima.

	public void alarmaOff(ControladorAlarma context) {
		ControladorAlarmaState estadoProgramado = getEstadoProgramado();
		context.setState(estadoProgramado);
		estadoProgramado.entryAction(context);
	}

	public void borraAlarma(ControladorAlarma context) {
		ControladorAlarmaState estadoProgramado = getEstadoProgramado();
		context.setState(estadoProgramado);
		estadoProgramado.entryAction(context);
	}

	public void nuevaAlarma(ControladorAlarma context) {
		System.out.println("OTRA ALARMA");
		ControladorAlarmaState estadoProgramado = getEstadoProgramado();
		context.setState(estadoProgramado);
		estadoProgramado.entryAction(context);
	}

	public void alarmaOn(ControladorAlarma context) {
		ControladorAlarmaState estadoProgramado = getEstadoProgramado();
		context.setState(estadoProgramado);
		estadoProgramado.entryAction(context);
	}

	// Clase de hacer sonar la alarma mas proxima
	public class SuenaAlarmaTask extends TimerTask {
		private ControladorAlarma context;
		public SuenaAlarmaTask(ControladorAlarma c) {
			context = c;
		}
		public void run() {
			ControladorAlarmaState estadoSonando = getEstadoSonando();
			context.setState(estadoSonando);
			estadoSonando.entryAction(context);
		}
	}

}